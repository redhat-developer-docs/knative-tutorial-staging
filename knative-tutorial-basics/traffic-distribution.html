<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knative Tutorial(Staging) :: Knative Tutorial(Staging)</title>
    <link rel="canonical" href="http://redhat-developer-docs.github.io/knative-tutorial-staging/knative-tutorial-basics/traffic-distribution.html">
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="http://redhat-developer-docs.github.io/knative-tutorial-staging">Knative Tutorial(Staging)</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container"  data-component="knative-tutorial-basics"
  data-version="master" >
  <aside class="navigation">
    <div class="panels">
      <div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Introduction to Knative</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="setup.html#tutorial-dev-env">Development Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="setup.html#tutorial-all-local">CLI Tools</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="setup.html#dev-env-all-in-one">All in one Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="basic-fundas.html">Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html">Knative Client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="knative-client.html#kn-install">Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-ksvc">Knative Service Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-create-ksvc">Create Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-list-services">List Knative Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-update-ksvc">Update Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-desc-ksvc">Describe Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-delete-ksvc">Delete Knative Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-revisons">Knative Revision Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-list">Knative Revision List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-desc">Knative Revision Describe</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-delete">Knative Revision Delete</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-routes">Knative Route Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-route-list">Knative Revision List</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="traffic-distribution.html">Traffic Distribution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-revisions">Arbitrary Revision Names</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#blue-green">Blue-Green Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#canary-release">Canary Release</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#service-visibility">Service Visibility</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="scaling.html">Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="scaling.html#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-observer-scale-to-zero">Observing Default Scale Down</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-observer-scale-to-zero-1m">Change Scale-to-Zero Time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="scaling.html#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="scaling.html#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-deploy-service-minscale">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/eventing.html">Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventing/eventing.html#eventing-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventing/eventing.html#usage-patterns">Usage Patterns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/eventing-src-to-sink.html">Source to Sink</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-source">Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-verify-event-source">Verify</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-sink-service">Sink Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-gen-sink-service">Generate Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-deploy-sink-service">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-src-to-sink.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/deploy-apache-kafka.html">Deploy Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/deploy-apache-kafka.html#create-kafka-topic">Create Topic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/deploy-apache-kafka.html#kafka-producer">Run Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/deploy-apache-kafka.html#kafka-consumer">Run Consumer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/channel-and-subscribers.html">Channel and Subscribers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-channel">Channel</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-create-event-channel">Create Event Channel</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-verify-event-channel">Verify</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/default-knative-channel.html">Default Knative Channel</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-source">Event Source</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-verify-event-source">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-subscriber">Event Subscriber</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-create-subscriber">Create Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-verify-subscriber">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="eventing/channel-and-subscribers.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="eventing/eventing-trigger-broker.html">Brokers and Triggers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#events-triggers-brokers">Events, Triggers and Brokers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#broker">Broker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#eventing-service">Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#eventing-event-source">Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#eventing-trigger">Trigger</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#eventing-trigger-verification">Verification</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing/eventing-trigger-broker.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventing/eventing.html#eventing-watch-logs">Watching Logs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">Frequently Asked Questions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
  <div class="navigation-explore" data-panel="explore">
  <div class="context">
    <!-- Just a place holder to fill in  explorer for each context -->
  </div>
</div>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../knative-tutorial/index.html" class="home-link"></a>
  <nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Introduction to Knative</a></li>
    <li class="crumb"><a href="traffic-distribution.html">Traffic Distribution</a></li>
  </ul>
</nav>
</div>
<article class="doc">
<h1>Knative Tutorial(Staging)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Providing custom name to deployment</p>
</li>
<li>
<p>Understanding advanced deployment techniques</p>
</li>
<li>
<p>Apply blue-green deployment pattern</p>
</li>
<li>
<p>Apply Canary Release Deployment pattern</p>
</li>
<li>
<p>Reduce the service visibility</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you noticed, Knative service always routes traffic to the <strong>latest</strong> revision of the service deployment. It is possible to split the traffic amongst the available revisions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-revisions"><a class="anchor" href="#deploying-revisions"></a>Arbitrary Revision Names</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default Knative generates a random revision names for the service based with Knative service&#8217;s <code>metadata.name</code> as prefix.</p>
</div>
<div class="paragraph">
<p>The following service deployments will show how to use an arbitrary revision names for the services. The service are exactly same <code>greeter</code> service except that their Revision name is specified using the service revision template spec.</p>
</div>
<div class="paragraph">
<p>Deploy greeter service revision v1:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/greeter-v1-service.yaml">greeter-v1</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v2
    spec:
      containers:
      - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
        env:
        - name: MESSAGE_PREFIX
          value: Namaste
        livenessProbe:
          httpGet:
            path: /healthz
        readinessProbe:
          httpGet:
            path: /healthz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy greeter service revision v2:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/greeter-v2-service.yaml">greeter-v2</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v2
    spec:
      containers:
      - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
        livenessProbe:
          httpGet:
            path: /healthz
        readinessProbe:
          httpGet:
            path: /healthz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check to ensure you have two revisions of the greeter service:</p>
</div>
<div class="sect2">
<h3 id="rev1-basics-show-knative-revisions"><a class="anchor" href="#rev1-basics-show-knative-revisions"></a>revisions</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset1_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_kubectl">
<div id="td-all-revsknative-revisions" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl --namespace knativetutorial get rev \
--selector=serving.knative.dev/service=greeter \
--sort-by="{.metadata.creationTimestamp}"</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#td-all-revsknative-revisions"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset1_oc">
<div id="td-all-revs-oc-knative-revisions" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --namespace knativetutorial get rev \
 --selector=serving.knative.dev/service=greeter \
 --sort-by="{.metadata.creationTimestamp}"</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#td-all-revs-oc-knative-revisions"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
<div class="paragraph">
<p>The command above should list two revisions namely <code>greeter-v1</code> and <code>greeter-v2</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>add <code>-oyaml</code> to the commands above to see more detail</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="blue-green"><a class="anchor" href="#blue-green"></a>Applying Blue-Green Deployment Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative offers a simple way of switching 100% of the traffic from one Knative service revision (blue) to another newly rolled out revision (green). If the new revision (e.g. green) has erroneous behavior then it is easy to rollback the change.</p>
</div>
<div class="paragraph">
<p>In this exercise you will applying theBlue/Green deployment pattern with the Knative Service called greeter. You have already deployed two <a href="#deploying-revisions">revisions</a> of greeter named <code>greeter-v1</code> and <code>greeter-v2</code> earlier in this chapter.</p>
</div>
<div class="paragraph">
<p>With the deployment of <code>greeter-v2</code> you noticed that Knative automatically started to routing 100% of the traffic to <code>greeter-v2</code>. Now let us assume that we need to roll back <code>greeter-v2</code> to <code>greeter-v1</code> for some critical reason.</p>
</div>
<div class="paragraph">
<p>The following Knative Service YAML is identical to the previously deployed <code>greeter-v2</code> except that we have added the <em>traffic</em> section to indicate that 100% of the traffic should be routed to <code>greeter-v1</code>.</p>
</div>
<div class="listingblock">
<div class="title">All traffic to greeter-v1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v2
    spec:
      containers:
        - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
          env:
            - name: MESSAGE_PREFIX
              value: Namaste
          livenessProbe:
            httpGet:
              path: /healthz
          readinessProbe:
            httpGet:
              path: /healthz
  traffic:
    - tag: v1
      revisionName: greeter-v1
      percent: 100
    - tag: v2
      revisionName: greeter-v2
      percent: 0
    - tag: latest
      latestRevision: true
      percent: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above service definition creates three sub-routes(named after traffic <strong>tags</strong>) to existing <code>greeter</code> route.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>current</strong> - The revision is going to have all 100% traffic distribution</p>
</li>
<li>
<p><strong>prev</strong> - The previously active revision, which will now have zero traffic</p>
</li>
<li>
<p><strong>latest</strong> - The route pointing to any latest service deployment, by setting to zero we are making sure the latest revision is not picked up automatically.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you observe the resource YAML above, we have added a special tag <code>latest</code>. Since you have defined that all 100% of traffic need to go to <code>greeter-v1</code>, this tag can be  used to suppress the default behavior of Knative Service to route all 100% traffic to latest revision.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before you apply the resource <code>$BOOK_HOME/basics/service-pinned.yaml</code>, call the <code>greeter</code> service again to verify that it is still providing the response from <code>greeter-v2</code> that includes <code>Namaste</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>$BOOK_HOME/bin/call.sh</strong>
Namaste  greeter => '9861675f8845' : 1

$ <strong>kubectl get pods</strong>
NAME                                    READY   STATUS    AGE
greeter-v2-deployment-9984bb56d-gr4gp   2/2     Running   14s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now apply the update Knative service configuration using the command as shown in following listing:</p>
</div>
<div class="listingblock">
<div class="title">Create greeter deployment (blue)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial apply -f service-pinned.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us list the available sub-routes:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset2_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_kubectl">
<div id="run-traffic-sub-routes" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get ksvc greeter -oyaml \
 | yq r - 'status.traffic[*].url'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#run-traffic-sub-routes"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset2_oc">
<div id="run-oc-traffic-sub-routes" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knativetutorial get ksvc greeter -oyaml \
  | yq r - 'status.traffic[*].url'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#run-oc-traffic-sub-routes"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
<div class="paragraph">
<p>The above command should return you three sub-routes for the main <code>greeter</code> route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">- <a href="http://current-greeter.knativetutorial.example.com" class="bare">http://current-greeter.knativetutorial.example.com</a> <i class="conum" data-value="1"></i><b>(1)</b>
- <a href="http://prev-greeter.knativetutorial.example.com" class="bare">http://prev-greeter.knativetutorial.example.com</a> <i class="conum" data-value="2"></i><b>(2)</b>
- <a href="http://latest-greeter.knativetutorial.example.com" class="bare">http://latest-greeter.knativetutorial.example.com</a> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the sub route for the traffic tag <code>current</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the sub route for the traffic tag <code>prev</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the sub route for the traffic tag <code>latest</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will notice that the command does not create any new configuration/revision/deployment as there was no application update (e.g. image tag, env var, etc), but when you call the service, Knative scales up the <code>greeter-v1</code> and the service responds with the text <strong>Hi  greeter &#8658; '9861675f8845' : 1</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>$BOOK_HOME/bin/call.sh</strong>
Hi  greeter =&gt; '9861675f8845' : 1

$ <strong>kubectl get pods</strong>
NAME                                     READY   STATUS    AGE
greeter-v1-deployment-6f75dfd9d8-s5bvr   2/2     Running   5s</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As an exercise, flip all the traffic back to <code>greeter-v2</code> (green). You need to edit the traffic block of the service-pinned.yaml and update the revision name to <code>greeter-v2</code>. After you redeploy the <code>service-pinned.yaml</code>, try calling the service again to notice the difference. If everything went smooth you will notice the service calls will now go to only <code>greeter-v2</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="canary"><a class="anchor" href="#canary"></a>Applying Canary Release Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Canary release is more effective when you want to reduce the risk of introducing new feature. It allows you a more effective feature-feedback loop before rolling out the change to your entire user base.</p>
</div>
<div class="paragraph">
<p>Knative allows you to split the traffic between revisions in increments as small as 1%.</p>
</div>
<div class="paragraph">
<p>To see this in action, apply the following Knative service definition that will split the traffic 80% to 20% between <code>greeter-v1</code> and <code>greeter-v2</code>.</p>
</div>
<div class="listingblock">
<div class="title">Canary between greeter v1 and v2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v2
    spec:
      containers:
        - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
          env:
            - name: MESSAGE_PREFIX
              value: Namaste
          livenessProbe:
            httpGet:
              path: /healthz
          readinessProbe:
            httpGet:
              path: /healthz
  traffic:
    - tag: v1
      revisionName: greeter-v1
      percent: 80
    - tag: v2
      revisionName: greeter-v2
      percent: 20
    - tag: latest
      latestRevision: true
      percent: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To roll out the greeter canary deployment use the following command:</p>
</div>
<div class="listingblock">
<div class="title">Create greeter canary Deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>kubectl -n knativetutorial apply -f service-canary.yaml</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>As in the previous section on <a href="#blue-green">Applying Blue-Green Deployment Pattern</a> deployments, the command will not create any new configuration/revision/deployment. To observe the traffic distribution you need to run the script <code>$BOOK_HOME/bin/poll.sh</code>, which is almost identical to <code>$BOOK_HOME/bin/call.sh</code> but will invoke the Knative service in a loop.</p>
</div>
<div class="listingblock">
<div class="title">Verify Canary rollout</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>$BOOK_HOME/bin/poll.sh</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the poll.sh script running you will see that approximately 80% of the responses are returned from <code>greeter-v1</code> and approximately 20% from <code>greeter-v2</code>. See the listing below for sample output:</p>
</div>
<div class="listingblock">
<div class="title">Sample greeter Canary roll out output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Hi  greeter =&gt; '9861675f8845' : 1
Hi  greeter =&gt; '9861675f8845' : 2
Namaste  greeter =&gt; '9861675f8845' : 1
Hi  greeter =&gt; '9861675f8845' : 3
Hi  greeter =&gt; '9861675f8845' : 4
Hi  greeter =&gt; '9861675f8845' : 5
Hi  greeter =&gt; '9861675f8845' : 6
Hi  greeter =&gt; '9861675f8845' : 7
Hi  greeter =&gt; '9861675f8845' : 8
Hi  greeter =&gt; '9861675f8845' : 9
Hi  greeter =&gt; '9861675f8845' : 10
Hi  greeter =&gt; '9861675f8845' : 11
Namaste  greeter =&gt; '9861675f8845' : 2
Hi  greeter =&gt; '9861675f8845' : 12
Hi  greeter =&gt; '9861675f8845' : 13
Hi  greeter =&gt; '9861675f8845' : 14
Hi  greeter =&gt; '9861675f8845' : 15
Hi  greeter =&gt; '9861675f8845' : 16
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should also notice that two pods are running representing both <code>greeter-v1</code> and <code>greeter-v2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>watch kubectl get pods</strong>
NAME                                     READY   STATUS    AGE
greeter-v1-deployment-6f75dfd9d8-86q89   2/2     Running   12s
greeter-v2-deployment-9984bb56d-n7xvm    2/2     Running   2s</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As a challenge, adjust the traffic distribution and observe the responses while the poll.sh script is actively running.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basics-cleanup"><a class="anchor" href="#basics-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset3_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_kubectl">
<div id="basics-run-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#basics-run-cleanup"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset3_oc">
<div id="basics-run-oc-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#basics-run-oc-cleanup"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer role="contentinfo">
  <div class="region region-rhd-footer">
    <div id="block-rhdfooter" class="rhd-footer">
      <nav class="rhd-footer-nav" aria-label="Secondary Navigation" role="navigation">
  <ul class="rhd-menu">
    <li class="menu-item menu-item--expanded">
      <h3 class="section-toggle">GitHub</h3>
      <ul class="rhd-menu">
        <li class="menu-item">
          <a href="https://github.com/redhat-developer-demos/knative-tutorial" title="Knative Tutorial">Knative
            Tutorial</a>
        </li>
        <li class="menu-item">
          <a href="https://github.com/redhat-developer-demos/knative-tutorial/issues" title="Issue Tracker">Issue
            Tracker</a>
        </li>
        <li class="menu-item">
          <a href="https://github.com/openshift-cloud-functions/Documentation"
            title="OpenShift Cloud Functions">OpenShift Cloud Functions</a>
        </li>
      </ul>
    </li>
  </ul>
</nav>
      <div class="rhd-footer-sidebar">
        <p class="rhd-footer-sidebar-title">Red Hat Developer</p>
        <p class="rhd-footer-sidebar-subtitle">Build here. Go anywhere.</p>
        <p class="rhd-footer-sidebar-content">
          We serve the builders. The problem solvers who create careers with
          code.<br /><br /><a href="https://developer.redhat.com/register">Join us</a>
          if you’re a developer, software engineer, web designer, front-end
          designer, UX designer, computer scientist, architect, tester,
          product manager, project manager or team lead.
        </p>
        <ul class="rhd-footer-sidebar-social">
          <li>
            <a href="https://www.youtube.com/channel/UC7noUdfWp-ukXUlAsJnSm-Q" target="_blank"
              rel="noopener noreferrer"><svg class="svg-inline--fa fa-youtube fa-w-18" aria-hidden="true"
                data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 576 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z">
                </path>
              </svg><!-- <i class="fab fa-youtube"></i> --></a>
          </li>
          <li>
            <a href="https://www.facebook.com/RedHatDeveloperProgram" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-facebook fa-w-14" aria-hidden="true" data-prefix="fab" data-icon="facebook"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M448 56.7v398.5c0 13.7-11.1 24.7-24.7 24.7H309.1V306.5h58.2l8.7-67.6h-67v-43.2c0-19.6 5.4-32.9 33.5-32.9h35.8v-60.5c-6.2-.8-27.4-2.7-52.2-2.7-51.6 0-87 31.5-87 89.4v49.9h-58.4v67.6h58.4V480H24.7C11.1 480 0 468.9 0 455.3V56.7C0 43.1 11.1 32 24.7 32h398.5c13.7 0 24.8 11.1 24.8 24.7z">
                </path>
              </svg><!-- <i class="fab fa-facebook"> </i> --></a>
          </li>
          <li>
            <a href="https://twitter.com/rhdevelopers" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-twitter fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="twitter"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                </path>
              </svg><!-- <i class="fab fa-twitter"> </i> --></a>
          </li>
          <li>
            <a href="https://github.com/redhat-developer" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="github"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
                </path>
              </svg><!-- <i class="fab fa-github"> </i> --></a>
          </li>
        </ul>
        <a class="rhd-footer-sidebar-signup" href="https://developers.redhat.com/register">Sign me up ▸</a>
      </div>
    </div>
  </div>
</footer>
<script src="../_/js/site.js"></script>
<script src="../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>
