<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Knative Tutorial(Staging) :: Knative Tutorial(Staging)</title>
    <link rel="canonical" href="http://redhat-developer-docs.github.io/knative-tutorial-staging/knative-tutorial-adv/deploy-apache-kafka.html">
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="http://redhat-developer-docs.github.io/knative-tutorial-staging">Knative Tutorial(Staging)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="knative-tutorial-adv" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Knative Eventing</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploy-apache-kafka.html">Deploy Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#create-kafka-topic">Create Topic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kafka-producer">Run Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kafka-consumer">Run Consumer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="eventing-with-kafka.html">Knative Eventing with Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-kafka-source">Deploy KafkaSource</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-adv-default-knative-channel">Kafka Knative Channel</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-kafka-source-to-sink">Kafka Source to Sink</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-kafka-auto-scaling">Auto Scaling with Kafka</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventing-with-kafka.html#kn-kafka-src-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">EIP with Apache Camel-K</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="camel-k-cbr.html">Content Based Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#cbr-app-overview">Application Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#label-namespace-for-default-broker">Label Namespace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-data-producer">Deploy Data Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-data-processor">Deploy Data Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-event-subscriber">Deploy Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-event-filter">Apply Knative Filter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#verify-e2e">Verify End to End</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#kamel-cbr-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../knative-tutorial/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Knative Tutorial Advanced</a></li>
    <li>Knative Eventing</li>
    <li><a href="deploy-apache-kafka.html">Deploy Apache Kafka</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial-module-advanced/edit/master/modules/ROOT/pages/deploy-apache-kafka.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Knative Tutorial(Staging)</h1>
<div class="sect1">
<h2 id="deploy-apache-kafka"><a class="anchor" href="#deploy-apache-kafka"></a>Deploying Apache Kafka Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As part of the upcoming section of this chapter, we will be deploying a <a href="#eventing-source">Knative Source</a>, that will respond to Apache Kafka Topic messages(events). Before getting to other exercises, we need to first deploy Apache Kafka inside in your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The <a href="https://operatorhub.io/operator/strimzi-kafka-operator">strimzi</a> Kubernetes <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">operator</a> can be used to deploy the Apache Kafka Cluster in your Kubernetes cluster.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/eventing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the following command to create the <code>kafka</code> namespace</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create namespace kafka</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy Apache Kafka into <code>kafka</code> namespace:</p>
</div>
<div id="eventing-deploy-kafka" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -L \
<a href="https://github.com/strimzi/strimzi-kafka-operator\" class="bare">https://github.com/strimzi/strimzi-kafka-operator\</a>
/releases/download/0.17.0/strimzi-cluster-operator-0.17.0.yaml \
  | sed 's/namespace:.*/namespace: kafka/' \
  | kubectl apply -n kafka -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the strimzi-cluster-operator to be running:</p>
</div>
<div id="eventing-watch-kafka-pods" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "kubectl get pods -n kafka"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                        READY STATUS    AGE
strimzi-cluster-operator-85f596bfc7-7dgds   1/1   Running   1m2s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The strimzi operator would have installed several Apache Kafka related CRDs which can be used to create Apache Kafka core resources such as a topic, users, connectors etc., you can verify the CRDs that are available by querying <code>api-resources</code>:</p>
</div>
<div id="eventing-watch-kafka-res" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl api-resources --api-group='kafka.strimzi.io'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                 SHORTNAMES   APIGROUP           NAMESPACED   KIND
kafkabridges         kb           kafka.strimzi.io   true         KafkaBridge
kafkaconnectors      kctr         kafka.strimzi.io   true         KafkaConnector
kafkaconnects        kc           kafka.strimzi.io   true         KafkaConnect
kafkaconnects2is     kcs2i        kafka.strimzi.io   true         KafkaConnectS2I
kafkamirrormaker2s   kmm2         kafka.strimzi.io   true         KafkaMirrorMaker2
kafkamirrormakers    kmm          kafka.strimzi.io   true         KafkaMirrorMaker
kafkas               k            kafka.strimzi.io   true         Kafka
kafkatopics          kt           kafka.strimzi.io   true         KafkaTopic
kafkausers           ku           kafka.strimzi.io   true         KafkaUser</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now with the Apache Kafka operator running, you can deploy and verify a single node Apache Kakfa cluster by running the command:</p>
</div>
<div id="create-kafka-cluster" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n kafka apply -f kafka-broker-my-cluster.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Watch the Kafka cluster deployment:</p>
</div>
<div id="watch-kafka-cluster" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "kubectl get pods -n kafka"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Watch the <code>kafka</code> namespace for the cluster deployment:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                         READY  STATUS   AGE
my-cluster-entity-operator-7d677bdf7b-jpws7  3/3    Running  85s
my-cluster-kafka-0                           2/2    Running  110s
my-cluster-zookeeper-0                       2/2    Running  2m22s
strimzi-cluster-operator-85f596bfc7-7dgds    1/1    Running  4m22s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kubernetes CRD resource <code>$TUTORIAL_HOME/eventing/kafka-broker-my-cluster.yaml</code>, will deploy a single <strong>Zookeeper</strong>, <strong>Kafka Broker</strong> and a <strong>Entity-Operator</strong>.  The <strong>Entity-Operator</strong> is responsible for managing different custom resources such as KafkaTopic and KafkaUser.</p>
</div>
<div class="paragraph">
<p>Now that you have an Apache Kafka cluster deployed, you can create a Kafka Topic using the KafkaTopic CRD, the following listing shows how to create a Kafka Topic <code>my-topic</code>:</p>
</div>
<div class="listingblock">
<div class="title">Create Kafka Topic my-topic</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10 <i class="conum" data-value="1"></i><b>(1)</b>
  replicas: 1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Partitions 10 allows for more concurrent scale-out of sink pods.  In theory, up to 10 pods will scale-up if there are enough messages flowing through the Kafka topic.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can choose to skip the manual pre-creation of a KafkaTopic but the automatically generated topics will have partitions set to 1 by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="create-kafka-topic"><a class="anchor" href="#create-kafka-topic"></a>Create Kafka Topic</h3>
<div id="oc-create-kakfa-topic" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n kafka create -f kafka-topic-my-topic.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the created topic:</p>
</div>
<div id="oc-verify-create-kakfa-topic" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n kafka  get kafkatopics</code></pre>
</div>
</div>
<div class="paragraph">
<p>The verify command should show the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME       PARTITIONS   REPLICATION FACTOR
my-topic   10           1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that your Kafka Topic is working correctly by connecting a simple producer, consumer and creating some test messages.  The sample code repository includes a script for producing Kafka messages called <code>kafka-producer.sh</code>.  Execute the script and type in "one", "two", "three".  Hitting enter/return after each string:</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka-producer"><a class="anchor" href="#kafka-producer"></a>Producer</h3>
<div id="run-kafka-producer" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/kafka-producer.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the terminal prompt try entering texts like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt;one
&gt;two
&gt;three</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-consumer"><a class="anchor" href="#kafka-consumer"></a>Consumer</h3>
<div class="paragraph">
<p>You should also leverage the sample code repository&#8217;s <code>kafka-consumer.sh</code> script to see the message flow through the topic, open a new terminal and run:</p>
</div>
<div id="run-kafka-consumer" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/kafka-consumer.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the consumer terminal prompt you will receive texts like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt;one
&gt;two
&gt;three</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use <kbd>Ctrl-c</kbd> to stop producer &amp; consumer interaction and their associated pods.</p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
