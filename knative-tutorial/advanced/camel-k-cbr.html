<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Applying Content Based Routing EIP :: Knative Tutorial(Staging)</title>
    <link rel="canonical" href="http://redhat-developer-docs.github.io/knative-tutorial-staging/knative-tutorial/advanced/camel-k-cbr.html">
    <link rel="prev" href="eventing-with-kafka.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="http://redhat-developer-docs.github.io/knative-tutorial-staging">Knative Tutorial(Staging)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="knative-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../setup/setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../setup/setup.html#download-tutorial-sources">Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../setup/setup.html#tools">Tutorial Tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../setup/kubernetes-cluster.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../setup/minikube.html">Minikube</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#start-minikube">Configure and Start Minikube</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#minikube-deploy-registry">Deploy Registry</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#install-knative-serving">Install Knative Serving</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#install-kourier-ingress-gateway">Install Kourier Ingress Gateway</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#install-ingress-controller">Install Ingress Controller</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#install-knative-eventing">Install Knative Eventing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../setup/minikube.html#create-tutorial-namespace">Create Tutorial Namespace</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../setup/openshift.html">OpenShift</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/index.html">Knative Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/knative-client.html">Knative Client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/knative-client.html#kn-install">Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/knative-client.html#kn-ksvc">Knative Service Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-create-ksvc">Create Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-list-services">List Knative Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-update-ksvc">Update Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-desc-ksvc">Describe Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-delete-ksvc">Delete Knative Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/knative-client.html#kn-revisons">Knative Revision Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-revisions-list">Knative Revision List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-revisions-desc">Knative Revision Describe</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-revisions-delete">Knative Revision Delete</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/knative-client.html#kn-routes">Knative Route Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/knative-client.html#kn-route-list">Knative Revision List</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/basic-fundas.html">Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#basics-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#basics-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/traffic-distribution.html">Revisions and Traffic Distribution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/traffic-distribution.html#deploy-colors-service">Deploy Colors Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/traffic-distribution.html#deploying-new-revision">Deploy New Revision</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/traffic-distribution.html#tag-service-revisions">Tagging Revisions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/traffic-distribution.html#blue-green">Blue-Green Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/traffic-distribution.html#canary-release">Canary Release</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/scaling.html">Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/scaling.html#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/scaling.html#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/scaling.html#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-observer-scale-to-zero">Observing Default Scale Down</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-observer-scale-to-zero-1m">Change Scale-to-Zero Time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/scaling.html#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../serving/scaling.html#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../serving/scaling.html#scaling-deploy-service-minscale">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../serving/scaling.html#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/index.html">Knative Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../eventing/eventing.html#eventing-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../eventing/eventing.html#eventing-watch-logs">Watching Logs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html">Source to Sink</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html#eventing-source">Event Source</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html#eventing-sink-service">Sink Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html#eventing-verify-event-source">Verify</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-src-to-sink.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/channel-and-subscribers.html">Channel and Subscribers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-channel">Channel</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-create-event-channel">Create Event Channel</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-verify-event-channel">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-source">Event Source</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-verify-event-source">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-subscriber">Event Subscriber</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-create-subscriber">Create Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-verify-subscriber">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/channel-and-subscribers.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html">Brokers and Triggers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#events-triggers-brokers">Events, Triggers and Brokers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#broker">Broker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#eventing-service">Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#eventing-event-source">Event Source</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#eventing-trigger">Trigger</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#eventing-trigger-verification">Verification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../eventing/eventing-trigger-broker.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../camelk/index.html">Apache Camel K</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../camelk/setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/setup.html#install-camel-k">Install Apache Camel K </a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../camelk/camel-k-basics.html">Camel K with Knative Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-basics.html#deploy-camel-k-integration">Deploy Camel K integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-basics.html#deploy-camel-k-kn-integration">Deploy Camel K Knative Integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-basics.html#camelk-gs-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../camelk/camel-k-eventing.html">Camel K with Knative Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-eventing.html#deploy-camel-k-source">Deploy Knative CamelSource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-eventing.html#logging-ce-messages">View CloudEvents Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-eventing.html#camel-k-es-sink">CamelSource to Sink</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../camelk/camel-k-eventing.html#camelk-eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Advanced</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Knative Eventing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploy-apache-kafka.html">Deploy Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-apache-kafka.html#create-kafka-topic">Create Topic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-apache-kafka.html#kafka-producer">Run Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-apache-kafka.html#kafka-consumer">Run Consumer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="eventing-with-kafka.html">Knative Eventing with Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-kafka-source">Deploy KafkaSource</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-adv-default-knative-channel">Kafka Knative Channel</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-kafka-source-to-sink">Kafka Source to Sink</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventing-with-kafka.html#kn-eventing-kafka-auto-scaling">Auto Scaling with Kafka</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventing-with-kafka.html#kn-kafka-src-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">EIP with Apache Camel K</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="camel-k-cbr.html">Content Based Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#cbr-app-overview">Application Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#label-namespace-for-default-broker">Create Broker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#camel-k-cbr-data-producer">Deploy Data Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#camel-k-cbr-data-processor">Deploy Data Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#camel-k-cbr-event-subscriber">Deploy Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#camel-k-cbr-event-filter">Apply Knative Filter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#verify-e2e">Verify End to End</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kamel-cbr-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Knative Tutorial</a></li>
    <li><a href="index.html">Advanced</a></li>
    <li>EIP with Apache Camel K</li>
    <li><a href="camel-k-cbr.html">Content Based Routing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial/edit/master/documentation/modules/advanced/pages/camel-k-cbr.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Applying Content Based Routing EIP</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to run integrate Apache Kafka and Camel-K</p>
</li>
<li>
<p>Apply Content Based Routing (CBR) Enterprise Integration Pattern(EIP)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Apache Camel supports numerous Enterprise Integration Patterns (EIPs) out-of-the-box, you can find the complete list of patterns on the Apache Camel <a href="https://camel.apache.org/manual/latest/enterprise-integration-patterns.html">website</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Content Based Router</div>
<div class="paragraph">
<p>The Content Based Router examines the message content and routes the message to a different channel based on the data contained in the message. The routing can be based on a number of criteria such as existence of fields, specific field values etc. When implementing a Content Based Router, special caution should be taken to make the routing function easy to maintain as the router can become a point of frequent maintenance. In more sophisticated integration scenarios, the Content Based Router can take on the form of a configurable rules engine that computes the destination channel based on a set of configurable rules. <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cbr-app-overview"><a class="anchor" href="#cbr-app-overview"></a>Application Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will deploy a simple data streaming application that will use Camel-K and Knative to process the incoming data where that processed data is pushed out to to a reactive web application via <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">Server-Sent Events (SSE)</a> as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/cbr_app_overview.png" alt="cbr app overview">
</div>
<div class="title">Figure 1. Application Overview</div>
</div>
<div class="paragraph">
<p>The application has following components,</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Data Producer</strong>: The Camel-K integration application, that will produce data simulating the streaming data by sending the data to <a href="https://kafka.apache.org">Apache Kafka</a></p>
</li>
<li>
<p><strong>Data Processor</strong>: The Camel-K integration application, that will process the streaming data from Kafka and send the default Knative Eventing Broker</p>
</li>
<li>
<p><strong>Event Subscriber(Fruits UI)</strong>: The <a href="https://quarkus.io">Quarkus</a> Java application, that will display the processed data from the Data Processor</p>
</li>
<li>
<p><strong>Event Trigger</strong>: This is <a href="#knative-tutorial-eventing:ROOT:eventing-trigger-broker.adoc" class="page unresolved">Knative Event Trigger</a> that apply a filter on the processed data, to send to the Event Subscriber</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The upcoming recipes will deploy these individual components and finally we test the integration by wiring them all together.</p>
</div>
<div class="paragraph">
<p>Just make sure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Review <a href="#eventing/eventing.adoc" class="page unresolved">Knative Eventing</a> module to refresh the concepts</p>
</li>
<li>
<p>Apache Kafka <a href="deploy-apache-kafka.html" class="page">my-cluster</a> is running</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="label-namespace-for-default-broker"><a class="anchor" href="#label-namespace-for-default-broker"></a>Create default Broker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have deleted the <strong>default</strong> broker, then you need to create the <strong>default</strong> broker to be used by this chapter&#8217;s exercises.</p>
</div>
<div class="paragraph">
<p>Navigate to the eventing chapter folder eventing:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/eventing</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/eventing/default-broker.yaml">default-broker</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: eventing.knative.dev/v1
kind: broker
metadata:
 name: default</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_kn"></a>kn</p>
</li>
<li>
<p><a id="tabset1_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_kn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kn broker create default \
  --namespace knativetutorial</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_kubectl">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/eventing/default-broker.yaml">${TUTORIAL_HOME}/eventing/default-broker.yaml</a></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Verify the created resources:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_kn"></a>kn</p>
</li>
<li>
<p><a id="tabset2_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_kn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kn broker -n knativetutorial list</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME      URL                                                                                AGE    CONDITIONS   READY   REASON
default   http://broker-ingress.knative-eventing.svc.cluster.local/knativetutorial/default   112s   5 OK / 5     True</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_kubectl">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get broker.eventing.knative.dev -n knativetutorial</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME      URL                                                                                AGE     READY   REASON
default   http://broker-ingress.knative-eventing.svc.cluster.local/knativetutorial/default   2m57s   True</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally navigate to the tutorial chapter&#8217;s folder advanced/camel-k:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/advanced/camel-k</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-cbr-data-producer"><a class="anchor" href="#camel-k-cbr-data-producer"></a>Deploy Data Producer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative Camel-K integration called <code>fruits-producer</code> which will use a public <a href="http://fruityvice.com">fruits API</a> to retrieve the information about fruits and stream the data to Apache Kafka. The <code>fruits-producer</code> service retrieves the data from the fruits API, splits it using the <a href="https://camel.apache.org/manual/latest/split-eip.html">Split EIP</a> and then sends the data to a Kafka topic called <code>fruits</code>.</p>
</div>
<div class="paragraph">
<p>As the Fruityvice services self-signed certificates which Quarkus does not allow out of the box, we will use a proxy that skips SSL check.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f $TUTORIAL_HOME/install/utils/fruityvice-proxy.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the frutiyvice proxy to be running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl rollout status deploy fruityvice-proxy</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Fruits producer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- from:
    uri: "knative:endpoint/fruits-producer"
    steps:
      - set-header:
          name: CamelHttpMethod
          constant: GET
      - to: "http:fruityvice-proxy:8080/api/fruit/all?bridgeEndpoint=true" <i class="conum" data-value="1"></i><b>(1)</b>
      - split:
          jsonpath: "$.[*]" <i class="conum" data-value="2"></i><b>(2)</b>
      - marshal:
          json: {}
      - log:
          message: "${body}"
      - to: "kafka:fruits?brokers=my-cluster-kafka-bootstrap.kafka:9092" <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call the external REST API <a href="http://fruityvice.com" class="bare">http://fruityvice.com</a> to get the list of fruits to simulate the data streaming</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply the Camel Split EIP to split the JSON array to individual records</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Send the processed data i.e. the individual fruit record as JSON to Apache Kafka Topic</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following command to deploy the <code>fruit-producer</code> integration:</p>
</div>
<div id="kamel-cbr-deploy-fruit-producer" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kamel -n knativetutorial run \
 --wait \
 --dependency camel:log \
 --dependency camel:jackson \
 --dependency camel:jsonpath \
 eip/fruits-producer.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The service deployment may take several minutes to become available, to monitor the status:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>watch kubectl get pods</code> or <code>watch oc get pods</code></p>
</li>
<li>
<p><code>watch kamel get</code></p>
</li>
<li>
<p><code>watch kubectl get ksvc</code>  or <code>watch oc get ksvc</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n knativetutorial get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful deploy will show the following pods:</p>
</div>
<div class="listingblock console-output">
<div class="title">fruits-producer service pods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                READY   STATUS    AGE
camel-k-operator-5d74595cdf-4v9qz                   1/1     Running   4h4m
fruityvice-proxy-76d6ff5f7f-rlrqh                   1/1     Running   4m1
<strong><em>fruits-producer-nfngm-deployment-759c797c44-d6r52   2/2     Running   70s</em></strong></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kn -n knativetutorial service ls</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">fruit-producer Knative services</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME              URL                                                           LATESTCREATED           LATESTREADY             READY   REASON
fruits-producer   <a href="http://fruits-producer.knativetutorial.192.168.64.13.nip.io" class="bare">http://fruits-producer.knativetutorial.192.168.64.13.nip.io</a>   fruits-producer-gl575   fruits-producer-gl575   True</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="kamel-cbr-fp-verify"><a class="anchor" href="#kamel-cbr-fp-verify"></a>Verify Fruit Producer</h3>
<div class="paragraph">
<p>Run the <code>$TUTORIAL_HOME/bin/call.sh</code> with the parameter <code>fruits-producer</code>.</p>
</div>
<div id="kamel-cbr-call-fp" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/call.sh fruits-producer ''</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open a new terminal and run the start Kafka consumer using the script <code>$TUTORIAL_HOME/bin/kafka-consumer.sh</code> with parameter <code>fruits</code>:</p>
</div>
<div id="kamel-cbr-kafka-consumer" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/kafka-consumer.sh fruits</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>fruit-producer</code> executed well then you should the Kafka Consumer terminal show something like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"genus":"Citrullus","name":"Watermelon","id":25,"family":"Cucurbitaceae","order":"Cucurbitales","nutritions":{"carbohydrates":8,"protein":0.6,"fat":0.2,"calories":30,"sugar":6}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the fruits API returns a static set of fruit data consistently, you can call it as needed to simulate data streaming and it will always be the same data.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-cbr-data-processor"><a class="anchor" href="#camel-k-cbr-data-processor"></a>Deploy Data Processor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us now deploy a CamelSource called <code>fruits-processor</code>, that can  handle and process the streaming data from the Kafka topic <code>fruits</code>. The <code>fruits-processor</code> CamelSource applies the <strong>Content Based Router</strong> EIP to process the data. The following listing describes the <code>fruits-processor</code> CamelSource:</p>
</div>
<div class="listingblock">
<div class="title">CamelSource fruits-processor</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: sources.eventing.knative.dev/v1alpha1
kind: CamelSource
metadata:
  name: fruits-processor
spec:
  source:
    integration:
      dependencies:
        - camel:log
        - camel:kafka
        - camel:jackson
        - camel:bean
    flow:
      from:
        uri: "kafka:fruits?brokers=my-cluster-kafka-bootstrap.kafka:9092" <i class="conum" data-value="1"></i><b>(1)</b>
        steps:
          - log:
              message: "Received Body ${body}"
          - unmarshal:
              json: {} <i class="conum" data-value="2"></i><b>(2)</b>
          - choice: <i class="conum" data-value="3"></i><b>(3)</b>
              when:
                - simple: "${body[nutritions][sugar]} &lt;= 5"
                  steps:
                    - remove-headers: "*"
                    - marshal:
                        json: {}
                    - set-header: <i class="conum" data-value="4"></i><b>(4)</b>
                        name: ce-type
                        constant: low-sugar
                    - set-header:
                        name: fruit-sugar-level
                        constant: low
                    - to: "log:low?showAll=true&amp;multiline=true"
                - simple: "${body[nutritions][sugar]} &gt; 5 &amp;&amp; ${body[nutritions][sugar]} &lt;= 10"
                  steps:
                    - remove-headers: "*"
                    - marshal:
                        json: {}
                    - set-header:
                        name: ce-type
                        constant: medium-sugar
                    - set-header:
                        name: fruit-sugar-level
                        constant: medium
                    - to: "log:medium?showAll=true&amp;multiline=true"
              otherwise:
                steps:
                  - remove-headers: "*"
                  - marshal:
                      json: {}
                  - set-header:
                      name: ce-type
                      constant: high-sugar
                  - set-header:
                      name: fruit-sugar-level
                      constant: high
                  - to: "log:high?showAll=true&amp;multiline=true"
  sink: <i class="conum" data-value="5"></i><b>(5)</b>
    ref:
      apiVersion: eventing.knative.dev/v1alpha1
      kind: Broker
      name: default</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Camel route connects to Apache Kafka broker and the topic <code>fruits</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Once the data is received it is transformed into a JSON payload.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>Content Based Router</code> pattern using the <a href="https://camel.apache.org/manual/latest/choice-eip.html">Choice EIP</a>. In the data processing you classify the fruits as low (sugar &lt;= 5), medium(sugar between 5 to 10) and high(sugar &gt; 10) based on the sugar level present in their nutritions data.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Based on the data classification you will be setting the <a href="https://cloudevents.io">CloudEvents</a> <code>type</code> header to be <code>low-high</code>, <code>medium-sugar</code> and <code>high-sugar</code>. This header is used as one of the filter attributes in the Knative Eventing Trigger.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The last step is to send the processed data to the Knative Eventing Broker named <code>default</code>.</td>
</tr>
</table>
</div>
<div id="kamel-deploy-data-processor" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f eip/fruits-processor.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the Camel-K controller takes few minutes to deploy the CamelSource, you can watch the pods of the <code>knativetutorial</code> namespace for its status:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n knativetutorial get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="title">fruit-processor Knative service pods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                      READY   STATUS    AGE
camel-k-operator-5d74595cdf-4v9qz         1/1     Running   4h17m
<strong><em>fruits-processor-h45f7-6fdfd74cf9-nmfkn   1/1     Running   29s</em></strong>
fruityvice-proxy-76d6ff5f7f-rlrqh         1/1     Running   24m</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful <code>fruit-processor</code> is deploy will show the following pods in <code>knativetutorial</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Wondering why <code>fruit-producer</code> is not listed ?</p>
</div>
<div class="paragraph">
<p><code>fruit-producer</code> is a Knative service, hence it wil be scaled down to zero in 60-90 seconds.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="kamel-cbr-query-camelsources" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get  -n knativetutorial camelsources</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the CamelSource deployment is successful you will see it in <code>READY</code> state as shown:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME               READY   REASON   AGE
fruits-processor   True             2m22s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-cbr-event-subscriber"><a class="anchor" href="#camel-k-cbr-event-subscriber"></a>Deploy Event Subscriber</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us now deploy a <a href="https://en.wikipedia.org/wiki/Reactive_programming">Reactive</a> Web application called fruit-events-display`. It is a <a href="https://quarkus.io">Quarkus</a> Java application, that will update UI(reactively) as and when it receives the processed data from the Knative Eventing backend.</p>
</div>
<div class="paragraph">
<p>You can deploy the <code>fruit-events-display</code> application using the command:</p>
</div>
<div id="kamel-cbr-deploy-event-sub" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial \
  -f $TUTORIAL_HOME/install/utils/fruit-events-display.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify if the <code>fruit-events-display</code> application is up and running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n knativetutorial get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the <code>fruit-events-display</code> is running you will see the following pods in the <code>knativetutorial</code>:</p>
</div>
<div class="listingblock console-output">
<div class="title">Pods list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                       READY   STATUS    AGE
camel-k-operator-5d74595cdf-4v9qz          1/1     Running   4h21m
<strong><em>fruit-events-display-8d47bc98f-6r7zt       1/1     Running   15s</em></strong>
fruits-processor-h45f7-6fdfd74cf9-nmfkn    1/1     Running   4m12s
fruityvice-proxy-76d6ff5f7f-rlrqh          1/1     Running   24m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The web <code>fruit-events-display</code> application will refresh its UI as and when it receives the processed data, you need you open the web application in your browser.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_minikube">
<div id="kamel-open-fruit-ui" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube -p knativetutorial -n knativetutorial service fruit-events-display</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div id="kamel-open-fruit-expose" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc expose -n knativetutorial service fruit-events-display</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have exposed the service, you can open the OpenShift route in the web browser:</p>
</div>
<div id="kamel-open-fruit-rt" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get -n knativetutorial route fruit-events-display</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>fruit-events-display</code> UI will be empty as shown below:</p>
</div>
<div id="fruit_events_page_before" class="imageblock text-center">
<div class="content">
<img src="_images/cbr_app_ui_empty.png" alt="cbr app ui empty">
</div>
<div class="title">Figure 2. Fruit events Display Web Application</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-cbr-event-filter"><a class="anchor" href="#camel-k-cbr-event-filter"></a>Apply Knative Filter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a last step let us now deploy a Knative Event Trigger called <code>fruits-trigger</code>. The trigger consumes the events from the Knative Event Broker named <code>default</code>, when the fruit event is received it will dispatch the events to the subscriber&#8201;&#8212;&#8201;that is <code>fruit-events-display</code> service --.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: sugary-fruits
spec:
  broker: default <i class="conum" data-value="1"></i><b>(1)</b>
  filter: <i class="conum" data-value="2"></i><b>(2)</b>
    attributes:
      type: low-sugar
  subscriber: <i class="conum" data-value="3"></i><b>(3)</b>
    ref:
      apiVersion: v1
      kind: Service
      name: fruit-events-display</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Knative Event Broker that this Trigger listens to for Knative events. Events originate from the CamelSource called <code>fruits-processor</code> and are sent to the Knative Eventing Broker named <code>default</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The filter attribute restricts the events that <code>fruit-events-display</code> will receive. In this example, it is configured to filter the events for the type <code>low-sugar</code>. You could also use the other classifications of fruits such as <code>medium-sugar</code> or <code>high-sugar</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the subscriber as the <code>fruit-events-display</code> Kubernetes service to receive the filtered event data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can deploy the Knative Event Trigger using the following command:</p>
</div>
<div id="kamel-cbr-deploy-trigger" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f eip/sugary-fruits.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us check the status of the Trigger using the command <code>kubectl -n knativetutorial get triggers</code> which should return one trigger called <code>sugary-fruits</code> with ready state as shown below.</p>
</div>
<div id="kamel-cbr-list-triggers" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get triggers</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the trigger will dispatch its filtered event to <code>fruit-events-display</code> , the subscriber URI of the Trigger will be that of <code>fruit-events-display</code> service.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME           READY BROKER    SUBSCRIBER_URI
sugary-fruits  True  default   <a href="http://fruits-events-display.knativetutorial.svc.cluster.local/" class="bare">http://fruits-events-display.knativetutorial.svc.cluster.local/</a></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verify-e2e"><a class="anchor" href="#verify-e2e"></a>Verify end to end</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have all the components for the <a href="#cbr-app-overview">Application Overview</a>, let us verify the end to end flow:</p>
</div>
<div class="paragraph">
<p>To verify the data flow and processing call the <code>fruits-producer</code> service using the script <code>$TUTORIAL_HOME/bin/call.sh</code> with parameters <code>fruits-producer</code> and ''.</p>
</div>
<div id="kamel-cbr-e2e-run" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/call.sh fruits-producer ''</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming everything worked well, you should see the <code>low-sugar</code> fruits listed in the <code>fruits-event-display</code> as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/cbr_app_ui_with_data.png" alt="cbr app ui with data">
</div>
<div class="title">Figure 3. Fruit events</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kamel-cbr-cleanup"><a class="anchor" href="#kamel-cbr-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div id="camelk-cbr-cleanup" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kamel delete  -n knativetutorial fruits-producer
kubectl delete  -n knativetutorial -f eip/fruits-processor.yaml
kubectl delete  -n knativetutorial -f eip/sugary-fruits.yaml
kubectl delete -n knativetutorial -f $TUTORIAL_HOME/install/utils/fruit-events-display.yaml
kubectl delete -n knativetutorial -f $TUTORIAL_HOME/install/utils/fruityvice-proxy.yaml
kn broker delete  -n knativetutorial default
kamel -n knativetutorial reset
kamel -n knativetutorial uninstall</code></pre>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/ContentBasedRouter.html" class="bare">https://www.enterpriseintegrationpatterns.com/patterns/messaging/ContentBasedRouter.html</a>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="eventing-with-kafka.html">Knative Eventing with Apache Kafka</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
