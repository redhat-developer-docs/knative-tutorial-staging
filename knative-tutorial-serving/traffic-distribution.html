<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Knative Tutorial(Staging) :: Knative Tutorial(Staging)</title>
    <link rel="canonical" href="http://redhat-developer-docs.github.io/knative-tutorial-staging/knative-tutorial-serving/traffic-distribution.html">
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="http://redhat-developer-docs.github.io/knative-tutorial-staging">Knative Tutorial(Staging)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="knative-tutorial-serving" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#tutorial-dev-env">Development Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="basic-fundas.html">Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="knative-client.html">Knative Client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="knative-client.html#kn-install">Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-ksvc">Knative Service Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-create-ksvc">Create Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-list-services">List Knative Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-update-ksvc">Update Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-desc-ksvc">Describe Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-delete-ksvc">Delete Knative Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-revisons">Knative Revision Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-list">Knative Revision List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-desc">Knative Revision Describe</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-delete">Knative Revision Delete</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-routes">Knative Route Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-route-list">Knative Revision List</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="traffic-distribution.html">Traffic Distribution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-revisions">Arbitrary Revision Names</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#blue-green">Blue-Green Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#canary-release">Canary Release</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="scaling.html">Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="scaling.html#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-observer-scale-to-zero">Observing Default Scale Down</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-observer-scale-to-zero-1m">Change Scale-to-Zero Time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="scaling.html#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="scaling.html#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scaling.html#scaling-deploy-service-minscale">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling.html#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">Frequently Asked Questions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../knative-tutorial/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Knative Serving</a></li>
    <li><a href="traffic-distribution.html">Traffic Distribution</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial-module-serving/edit/master/modules/ROOT/pages/traffic-distribution.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Knative Tutorial(Staging)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Providing custom name to deployment</p>
</li>
<li>
<p>Understanding advanced deployment techniques</p>
</li>
<li>
<p>Apply blue-green deployment pattern</p>
</li>
<li>
<p>Apply Canary Release Deployment pattern</p>
</li>
<li>
<p>Reduce the service visibility</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you noticed, Knative service always routes traffic to the <strong>latest</strong> revision of the service deployment. It is possible to split the traffic amongst the available revisions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-revisions"><a class="anchor" href="#deploying-revisions"></a>Arbitrary Revision Names</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default Knative generates a random revision names for the service based with Knative service&#8217;s <code>metadata.name</code> as prefix.</p>
</div>
<div class="paragraph">
<p>The following service deployments will show how to use an arbitrary revision names for the services. The service are exactly same <code>greeter</code> service except that their Revision name is specified using the service revision template spec.</p>
</div>
<div class="paragraph">
<p>Deploy greeter service revision v1:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/greeter-v1-service.yaml">greeter-v1</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v1
    spec:
      containers:
        - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
          livenessProbe:
            httpGet:
              path: /healthz
          readinessProbe:
            httpGet:
              path: /healthz</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl apply -n knativetutorial -f greeter-v1-service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy greeter service revision v2:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/greeter-v2-service.yaml">greeter-v2</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v2
    spec:
      containers:
        - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
          env:
            - name: MESSAGE_PREFIX
              value: Namaste
          livenessProbe:
            httpGet:
              path: /healthz
          readinessProbe:
            httpGet:
              path: /healthz</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl apply -n knativetutorial -f greeter-v2-service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check to ensure you have two revisions of the greeter service:</p>
</div>
<div class="sect2">
<h3 id="rev1-basics-show-knative-revisions"><a class="anchor" href="#rev1-basics-show-knative-revisions"></a>revisions</h3>
<div id="td-all-revsknative-revisions" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl --namespace knativetutorial get rev \
--selector=serving.knative.dev/service=greeter \
--sort-by="{.metadata.creationTimestamp}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above should list two revisions namely <code>greeter-v1</code> and <code>greeter-v2</code>.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME         CONFIG NAME   K8S SERVICE NAME   GENERATION   READY
greeter-v1   greeter       greeter-v1         1            True
greeter-v2   greeter       greeter-v2         2            True</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>add <code>-oyaml</code> to the commands above to see more detail</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="blue-green"><a class="anchor" href="#blue-green"></a>Applying Blue-Green Deployment Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative offers a simple way of switching 100% of the traffic from one Knative service revision (blue) to another newly rolled out revision (green). If the new revision (e.g. green) has erroneous behavior then it is easy to rollback the change.</p>
</div>
<div class="paragraph">
<p>In this exercise you will applying theBlue/Green deployment pattern with the Knative Service called greeter. You have already deployed two <a href="#deploying-revisions">revisions</a> of greeter named <code>greeter-v1</code> and <code>greeter-v2</code> earlier in this chapter.</p>
</div>
<div class="paragraph">
<p>With the deployment of <code>greeter-v2</code> you noticed that Knative automatically started to routing 100% of the traffic to <code>greeter-v2</code>. Now let us assume that we need to roll back <code>greeter-v2</code> to <code>greeter-v1</code> for some critical reason.</p>
</div>
<div class="paragraph">
<p>The following Knative Service YAML is identical to the previously deployed <code>greeter-v2</code> except that we have added the <em>traffic</em> section to indicate that 100% of the traffic should be routed to <code>greeter-v1</code>.</p>
</div>
<div class="listingblock">
<div class="title">All traffic to greeter-v1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v1
    spec:
      containers:
        - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
          livenessProbe:
            httpGet:
              path: /healthz
          readinessProbe:
            httpGet:
              path: /healthz
  traffic:
    - tag: v1
      revisionName: greeter-v1
      percent: 100
    - tag: v2
      revisionName: greeter-v2
      percent: 0
    - tag: latest
      latestRevision: true
      percent: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above service definition creates three sub-routes(named after traffic <strong>tags</strong>) to existing <code>greeter</code> route.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>v1</strong> - The revision is going to have all 100% traffic distribution</p>
</li>
<li>
<p><strong>v2</strong> - The previously active revision, which will now have zero traffic</p>
</li>
<li>
<p><strong>latest</strong> - The route pointing to any latest service deployment, by setting to zero we are making sure the latest revision is not picked up automatically.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you observe the resource YAML above, we have added a special tag <code>latest</code>. Since you have defined that all 100% of traffic need to go to <code>greeter-v1</code>, this tag can be  used to suppress the default behavior of Knative Service to route all 100% traffic to latest revision.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before you apply the resource <code>$TUTORIAL_HOME/basics/service-pinned.yaml</code>, call the <code>greeter</code> service again to verify that it is still providing the response from <code>greeter-v2</code> that includes <code>Namaste</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/call.sh</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Namaste  greeter => '9861675f8845' : 1</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                    READY   STATUS    AGE
greeter-v2-deployment-9984bb56d-gr4gp   2/2     Running   14s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now apply the update Knative service configuration using the command as shown in following listing:</p>
</div>
<div class="listingblock console-input">
<div class="title">Create greeter deployment (blue)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial apply -f service-pinned.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us list the available sub-routes:</p>
</div>
<div id="run-traffic-sub-routes" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get ksvc greeter -oyaml \
 | yq r - 'status.traffic[*].url'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command should return you three sub-routes for the main <code>greeter</code> route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">- <a href="http://current-greeter.knativetutorial.example.com" class="bare">http://current-greeter.knativetutorial.example.com</a> <i class="conum" data-value="1"></i><b>(1)</b>
- <a href="http://prev-greeter.knativetutorial.example.com" class="bare">http://prev-greeter.knativetutorial.example.com</a> <i class="conum" data-value="2"></i><b>(2)</b>
- <a href="http://latest-greeter.knativetutorial.example.com" class="bare">http://latest-greeter.knativetutorial.example.com</a> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the sub route for the traffic tag <code>current</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the sub route for the traffic tag <code>prev</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the sub route for the traffic tag <code>latest</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will notice that the command does not create any new configuration/revision/deployment as there was no application update (e.g. image tag, env var, etc), but when you call the service, Knative scales up the <code>greeter-v1</code> and the service responds with the text <strong>Hi  greeter &#8658; '9861675f8845' : 1</strong>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/call.sh</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Hi  greeter =&gt; '9861675f8845' : 1</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                        READY   STATUS        RESTARTS   AGE
greeter-9x8zn-deployment-84c946dd65-x2cbz   2/2     Terminating   0          82s
greeter-v1-deployment-7ff594cc7b-d9h6l      2/2     Running       0          9s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>greeter-v1</code> is the active revision now, the existing <code>greeter-v2</code> pod is getting terminated as no future requests will be served by it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As an exercise, flip all the traffic back to <code>greeter-v2</code> (green). You need to edit the traffic block of the service-pinned.yaml and update the revision name to <code>greeter-v2</code>. After you redeploy the <code>service-pinned.yaml</code>, try calling the service again to notice the difference. If everything went smooth you will notice the service calls will now go to only <code>greeter-v2</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="canary-release"><a class="anchor" href="#canary-release"></a>Applying Canary Release Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Canary release is more effective when you want to reduce the risk of introducing new feature. It allows you a more effective feature-feedback loop before rolling out the change to your entire user base.</p>
</div>
<div class="paragraph">
<p>Knative allows you to split the traffic between revisions in increments as small as 1%.</p>
</div>
<div class="paragraph">
<p>To see this in action, apply the following Knative service definition that will split the traffic 80% to 20% between <code>greeter-v1</code> and <code>greeter-v2</code>.</p>
</div>
<div class="listingblock">
<div class="title">Canary between greeter v1 and v2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    metadata:
      name: greeter-v2
    spec:
      containers:
        - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
          env:
            - name: MESSAGE_PREFIX
              value: Namaste
          livenessProbe:
            httpGet:
              path: /healthz
          readinessProbe:
            httpGet:
              path: /healthz
  traffic:
    - tag: v1
      revisionName: greeter-v1
      percent: 80
    - tag: v2
      revisionName: greeter-v2
      percent: 20
    - tag: latest
      latestRevision: true
      percent: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To roll out the greeter canary deployment use the following command:</p>
</div>
<div class="listingblock console-input">
<div class="title">Create greeter canary Deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial apply -f service-canary.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>As in the previous section on <a href="#blue-green">Applying Blue-Green Deployment Pattern</a> deployments, the command will not create any new configuration/revision/deployment. To observe the traffic distribution you need to run the script <code>$TUTORIAL_HOME/bin/poll.sh</code>, which is almost identical to <code>$TUTORIAL_HOME/bin/call.sh</code> but will invoke the Knative service in a loop.</p>
</div>
<div class="listingblock console-input">
<div class="title">Verify Canary rollout</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/poll.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the poll.sh script running you will see that approximately 80% of the responses are returned from <code>greeter-v1</code> and approximately 20% from <code>greeter-v2</code>. See the listing below for sample output:</p>
</div>
<div class="listingblock console-output">
<div class="title">Sample greeter Canary roll out output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Hi  greeter =&gt; '9861675f8845' : 1
Hi  greeter =&gt; '9861675f8845' : 2
Namaste  greeter =&gt; '9861675f8845' : 1
Hi  greeter =&gt; '9861675f8845' : 3
Hi  greeter =&gt; '9861675f8845' : 4
Hi  greeter =&gt; '9861675f8845' : 5
Hi  greeter =&gt; '9861675f8845' : 6
Hi  greeter =&gt; '9861675f8845' : 7
Hi  greeter =&gt; '9861675f8845' : 8
Hi  greeter =&gt; '9861675f8845' : 9
Hi  greeter =&gt; '9861675f8845' : 10
Hi  greeter =&gt; '9861675f8845' : 11
Namaste  greeter =&gt; '9861675f8845' : 2
Hi  greeter =&gt; '9861675f8845' : 12
Hi  greeter =&gt; '9861675f8845' : 13
Hi  greeter =&gt; '9861675f8845' : 14
Hi  greeter =&gt; '9861675f8845' : 15
Hi  greeter =&gt; '9861675f8845' : 16
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should also notice that two pods are running representing both <code>greeter-v1</code> and <code>greeter-v2</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "kubectl get pods"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                     READY   STATUS    AGE
greeter-v1-deployment-6f75dfd9d8-86q89   2/2     Running   12s
greeter-v2-deployment-9984bb56d-n7xvm    2/2     Running   2s</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As a challenge, adjust the traffic distribution and observe the responses while the poll.sh script is actively running.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basics-cleanup"><a class="anchor" href="#basics-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div id="basics-run-cleanup" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
