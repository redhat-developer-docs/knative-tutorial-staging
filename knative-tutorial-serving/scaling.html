<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knative Tutorial(Staging) :: Knative Tutorial(Staging)</title>
    <link rel="canonical" href="http://redhat-developer-docs.github.io/knative-tutorial-staging/knative-tutorial-serving/scaling.html">
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="http://redhat-developer-docs.github.io/knative-tutorial-staging">Knative Tutorial(Staging)</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container"  data-component="knative-tutorial-serving"
  data-version="master" >
  <aside class="navigation">
    <div class="panels">
      <div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Knative Serving</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="setup.html#tutorial-dev-env">Development Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="setup.html#tutorial-all-local">CLI Tools</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="setup.html#dev-env-all-in-one">All in one Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="basic-fundas.html">Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html">Knative Client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="knative-client.html#kn-install">Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-ksvc">Knative Service Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-create-ksvc">Create Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-list-services">List Knative Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-update-ksvc">Update Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-desc-ksvc">Describe Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-delete-ksvc">Delete Knative Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-revisons">Knative Revision Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-list">Knative Revision List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-desc">Knative Revision Describe</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-revisions-delete">Knative Revision Delete</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="knative-client.html#kn-routes">Knative Route Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="knative-client.html#kn-route-list">Knative Revision List</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="traffic-distribution.html">Traffic Distribution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="traffic-distribution.html#deploying-revisions">Arbitrary Revision Names</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="traffic-distribution.html#blue-green">Blue-Green Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="traffic-distribution.html#canary-release">Canary Release</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="traffic-distribution.html#service-visibility">Service Visibility</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="scaling.html">Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-observer-scale-to-zero">Observing Default Scale Down</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-observer-scale-to-zero-1m">Change Scale-to-Zero Time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-deploy-service-minscale">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">Frequently Asked Questions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
  <div class="navigation-explore" data-panel="explore">
  <div class="context">
    <!-- Just a place holder to fill in  explorer for each context -->
  </div>
</div>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../knative-tutorial/index.html" class="home-link"></a>
  <nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Knative Serving</a></li>
    <li class="crumb"><a href="scaling.html">Scaling</a></li>
  </ul>
</nav>
</div>
<article class="doc">
<h1>Knative Tutorial(Staging)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand what scale-to-zero is and why it&#8217;s important.</p>
</li>
<li>
<p>Configure the scale-to-zero time period.</p>
</li>
<li>
<p>Configure the autoscaler.</p>
</li>
<li>
<p>Understand types of autoscaling strategies.</p>
</li>
<li>
<p>Enable concurrency based autoscaling.</p>
</li>
<li>
<p>Configure a minimum number of replicas for a service.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-prerequisite"><a class="anchor" href="#scaling-prerequisite"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following checks ensure that each chapter exercises are done with the right environment settings.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_kubernetes">
<div class="ulist">
<ul>
<li>
<p>Set your local docker to use minikube docker daemon</p>
</li>
</ul>
</div>
<div id="minikube-set-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(minikube docker-env)</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#minikube-set-env"><i class="fa fa-clipboard"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Kubernetes should be v1.15+</p>
</li>
</ul>
</div>
<div id="kubectl-version" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl version</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#kubectl-version"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="ulist">
<ul>
<li>
<p>OpenShift CLI should be v4.1+</p>
</li>
</ul>
</div>
<div id="oc-version" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc version</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#oc-version"><i class="fa fa-clipboard"></i></button><br/>
<div class="paragraph">
<p>The output should be like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc version
Client Version: openshift-clients-4.3.0-201910250623-88-g6a937dfe
Kubernetes Version: v1.16.2</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to be on <code>knativetutorial</code> OpenShift project</p>
</li>
</ul>
</div>
<div id="right-openshift-project" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project -q</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#right-openshift-project"><i class="fa fa-clipboard"></i></button><br/>
<div class="paragraph">
<p>If you are not on <code>knativetutorial</code> project, then run following command to change to <code>knativetutorial</code> project:</p>
</div>
<div id="change-to-openshift-project" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project knativetutorial</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#change-to-openshift-project"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
<div class="paragraph">
<p>Navigate to the tutorial chapter&#8217;s <code>basics</code> folder:</p>
</div>
<div id="scaling-navigate-to-basics" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/basics</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-navigate-to-basics"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
<div class="sect1">
<h2 id="scaling-deploy-service"><a class="anchor" href="#scaling-deploy-service"></a>Deploy Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following snippet shows what a Knative service YAML will look like:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/service.yaml">service.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: greeter
spec:
  template:
    spec:
      containers:
      - image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
        livenessProbe:
          httpGet:
            path: /healthz
        readinessProbe:
          httpGet:
            path: /healthz</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service can be deployed using the command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset2_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_kubectl">
<div id="crtd-rev1-apply-kn-resources-apply" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/service.yaml">service.yaml</a></code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#crtd-rev1-apply-kn-resources-apply"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset2_oc">
<div id="crtd-rev1-apply-oc-kn-resources-apply" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/basics/service.yaml">service.yaml</a></code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#crtd-rev1-apply-oc-kn-resources-apply"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After the deployment of the service was successful we should see a Kubernetes deployment like <code>greeter-v1-deployment</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-invoke-service"><a class="anchor" href="#scaling-invoke-service"></a>Invoke Service</h2>
<div class="sectionbody">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_kubernetes">
<div id="scaling-is-kubectl-svc-gateway-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP_ADDRESS="$(minikube ip):$(kubectl get svc kourier-external --namespace kourier-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')"</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-is-kubectl-svc-gateway-env"><i class="fa fa-clipboard"></i></button><br/>
<div id="scaling-is-kubectl-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http $IP_ADDRESS 'Host:greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-is-kubectl-svc-call"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div id="scaling-is-minishift-oc-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export SVC_URL=`oc get rt greeter -o yaml | yq read - 'status.url'` &amp;&amp; \
http $SVC_URL</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-is-minishift-oc-svc-call"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
<div class="paragraph">
<p>The last <code>http</code> command should return a response like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong></p>
</div>
<div class="paragraph">
<p>Check <a href="basic-fundas.html#basics-see-what-you-have-deployed" class="page">deployed Knative resources</a> for more details on which Knative objects and resources have been created with the service deployment above.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-scale-to-zero"><a class="anchor" href="#scaling-scale-to-zero"></a>Scale to zero</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Assuming that <a href="#scaling-deploy-service">Greeter service</a> has been deployed, once no more traffic is seen going into that service, we&#8217;d like to scale this service down to zero replicas. That&#8217;s called <strong>scale-to-zero</strong>.</p>
</div>
<div class="paragraph">
<p>Scale-to-zero is one of the main properties making Knative a serverless platform. After a defined time of idleness (the so called <code>stable-window</code>) a revision is considered <strong>inactive</strong>. Now, all routes pointing to the now inactive revision will be pointed to the so-called <strong>activator</strong>. This reprogramming of the network is asynchronous in nature so the <code>scale-to-zero-grace-period</code> should give enough slack for this to happen. Once the <code>scale-to-zero-grace-period</code> is over, the revision will finally be scaled to zero replicas.</p>
</div>
<div class="paragraph">
<p>If another request tries to get to this revision, the activator will get it, instruct the autoscaler to create new pods for the revision as quickly as possible and buffer the request until those new pods are created.</p>
</div>
<div class="paragraph">
<p>By default the <strong>scale-to-zero-grace-period</strong> is <code>30s</code>, and the <strong>stable-window</strong> is <code>60s</code>. Firing a request to the greeter service will bring up the pod (if it is already terminated, as described above) to serve the request. Leaving it without any further requests will automatically cause it to scale to zero in approx <code>60-70 secs</code>. There are at least 20 seconds after the pod starts to terminate and before it&#8217;s completely terminated. This gives Istio enough time to leave out the pod from its own networking configuration.</p>
</div>
<div class="paragraph">
<p>For better clarity and understanding let us <a href="#scaling-cleanup">clean up</a> the deployed Knative resources before going to next section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-auto-scaling"><a class="anchor" href="#scaling-auto-scaling"></a>Auto Scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default Knative Serving allows 100 concurrent requests into a pod. This is defined by the <code>container-concurrency-target-default</code> setting in the configmap <strong>config-autoscaler </strong> in the <strong>knative-serving</strong> namespace.</p>
</div>
<div class="paragraph">
<p>For this exercise let us make our service handle only <strong>10</strong> concurrent requests. This will cause Knative autoscaler to scale to more pods as soon as we run more than 10 requests in parallel against the revision.</p>
</div>
<div class="sect2">
<h3 id="scaling-concurrency-10"><a class="anchor" href="#scaling-concurrency-10"></a>Service with concurrency of 10 requests</h3>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/scaling/service-10.yaml">service-10.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: prime-generator
spec:
  template:
    metadata:
      annotations:
        # Target 10 in-flight-requests per pod.
        autoscaling.knative.dev/target: "10"
    spec:
      containers:
      - image: quay.io/rhdevelopers/prime-generator:v27-quarkus
        livenessProbe:
          httpGet:
            path: /healthz
        readinessProbe:
          httpGet:
            path: /healthz</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Knative service definition above will allow each service pod to handle max of 10 in-flight requests per pod (configured via <code>autoscaling.knative.dev/target</code> annotation) before automatically scaling to new pod(s)</p>
</div>
</div>
<div class="sect2">
<h3 id="scaling-autoscaling-deploy-service"><a class="anchor" href="#scaling-autoscaling-deploy-service"></a>Deploy service</h3>
<div class="exampleblock">
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset4_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_kubectl">
<div id="scaling-run-autoscale-10-kn-resources-apply" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/scaling/service-10.yaml">service-10.yaml</a></code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-run-autoscale-10-kn-resources-apply"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset4_oc">
<div id="scaling-run-autoscale-10-oc-kn-resources-apply" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/scaling/service-10.yaml">service-10.yaml</a></code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-run-autoscale-10-oc-kn-resources-apply"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-autoscaling-invoke-service"><a class="anchor" href="#scaling-autoscaling-invoke-service"></a>Invoke Service</h3>
<div class="paragraph">
<p>We will not invoke the service directly as we need to send the load to see the autoscaling:</p>
</div>
<div class="paragraph">
<p>Open a new terminal and run the following command:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset5_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_kubectl">
<div id="autoscale-kubectl-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'kubectl get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#autoscale-kubectl-watch-scale"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset5_oc">
<div id="autoscale-oc-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'oc get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#autoscale-oc-watch-scale"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-load-service"><a class="anchor" href="#scaling-load-service"></a>Load the service</h3>
<div class="paragraph">
<p>We will now send some load to the greeter service.  The command below sends 50 concurrent requests (<code>-c 50</code>) for the next 10s (<code>-z 30s</code>)</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset6_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_kubernetes">
<div id="scaling-run-siege" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">hey -c 50 -z 10s \
  -H "Host:prime-generator.knativetutorial.example.com" \
  "http://${IP_ADDRESS}/?sleep=3&amp;upto=10000&amp;memload=100"</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-run-siege"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset6_openshift">
<div id="oc-scaling-run-siege" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">hey -c 50 -z 10s \
  "${SVC_URL}/?sleep=3&amp;upto=10000&amp;memload=100"</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#oc-scaling-run-siege"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
<div class="paragraph">
<p>After you&#8217;ve successfully run this small load test, you will notice the number of greeter service pods will have scaled to 5 automatically.</p>
</div>
<div class="paragraph">
<p>The autoscale pods is computed using the formula:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">totalPodsToScale = inflightRequests / concurrencyTarget</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this current setting of <strong>concurrencyTarget=10</strong> and <strong>inflightRequests=50</strong> , you will see Knative automatically scales the greeter services to  <code><strong>50/10 = 5 pods</strong></code>.</p>
</div>
<div class="paragraph">
<p>For more clarity and understanding let us <a href="#scaling-cleanup">clean up</a> existing deployments before proceeding to next section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-min-scale"><a class="anchor" href="#scaling-min-scale"></a>Minimum Scale</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In real world scenarios your service might need to handle sudden spikes in requests. Knative starts each service with a default of <strong>1</strong> replica. As described above, this will eventually be scaled to zero as described above. If your app needs to stay particularly responsive under any circumstances and/or has a long startup time, it might be beneficial to always keep a minimum number of pods around. This can be done via an the annotation <strong>autoscaling.knative.dev/minScale</strong>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to make Knative create services that start with a replica count of <strong>2</strong> and never scale below it.</p>
</div>
<div class="sect2">
<h3 id="scaling-deploy-service-minscale"><a class="anchor" href="#scaling-deploy-service-minscale"></a>Deploy service</h3>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/scaling/service-min-max-scale.yaml">service-min-max-scale.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: prime-generator
spec:
  template:
    metadata:
      annotations:
        # the minimum number of pods to scale down to
        autoscaling.knative.dev/minScale: "2"
        # Target 10 in-flight-requests per pod.
        autoscaling.knative.dev/target: "10"
    spec:
      containers:
      - image: quay.io/rhdevelopers/prime-generator:v27-quarkus
        livenessProbe:
          httpGet:
            path: /healthz
        readinessProbe:
          httpGet:
            path: /healthz</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The deployment of this service will always have a minimum of 2 pods.</p>
</li>
<li>
<p>Will allow each service pod to handle max of 10 in-flight requests per pod before automatically scaling to new pods.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset7_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_kubectl">
<div id="scaling-run-min-scale-kn-resources-apply" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/scaling/service-min-max-scale.yaml">service-min-max-scale.yaml</a></code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-run-min-scale-kn-resources-apply"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset7_oc">
<div id="scaling-run-min-scale-oc-kn-resources-apply" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/scaling/service-min-max-scale.yaml">service-min-max-scale.yaml</a></code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#scaling-run-min-scale-oc-kn-resources-apply"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After the deployment was successful we should see a Kubernetes Deployment called <code>prime-generator-v2-deployment</code> with <strong>two</strong> pods available.</p>
</div>
<div class="paragraph">
<p>Open a new terminal and run the following command :</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset8_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset8_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset8_kubectl">
<div id="min-scale-kubectl-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'kubectl get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#min-scale-kubectl-watch-scale"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset8_oc">
<div id="min-scale-oc-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'oc get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#min-scale-oc-watch-scale"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
<div class="paragraph">
<p>Let us <a href="#scaling-load-service">send some load to the service</a> to trigger autoscaling.</p>
</div>
<div class="paragraph">
<p>When all requests are done and if we are beyond the <code>scale-to-zero-grace-period</code>, we will notice that Knative has terminated only 3 out 5 pods. This is because we have configured Knative to always run two pods via the annotation <code>autoscaling.knative.dev/minScale: "2"</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-cleanup"><a class="anchor" href="#scaling-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset9_kubectl"></a>kubectl</p>
</li>
<li>
<p><a id="tabset9_oc"></a>oc</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset9_kubectl">
<div id="run-scaling-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial delete services.serving.knative.dev greeter  &amp;&amp;\
kubectl -n knativetutorial delete services.serving.knative.dev prime-generator</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#run-scaling-cleanup"><i class="fa fa-clipboard"></i></button><br/>
</div>
<div class="tab-pane" aria-labelledby="tabset9_oc">
<div id="run-oc-scaling-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knativetutorial delete services.serving.knative.dev greeter &amp;&amp;\
oc -n knativetutorial delete services.serving.knative.dev prime-generator</code></pre>
</div>
</div>
<button class="copybtn float-right" title="Copy to clipboard" data-clipboard-target="#run-oc-scaling-cleanup"><i class="fa fa-clipboard"></i></button><br/>
</div>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer role="contentinfo">
  <div class="region region-rhd-footer">
    <div id="block-rhdfooter" class="rhd-footer">
      <nav class="rhd-footer-nav" aria-label="Secondary Navigation" role="navigation">
  <ul class="rhd-menu">
    <li class="menu-item menu-item--expanded">
      <h3 class="section-toggle">GitHub</h3>
      <ul class="rhd-menu">
        <li class="menu-item">
          <a href="https://github.com/redhat-developer-demos/knative-tutorial" title="Knative Tutorial">Knative
            Tutorial</a>
        </li>
        <li class="menu-item">
          <a href="https://github.com/redhat-developer-demos/knative-tutorial/issues" title="Issue Tracker">Issue
            Tracker</a>
        </li>
        <li class="menu-item">
          <a href="https://github.com/openshift-cloud-functions/Documentation"
            title="OpenShift Cloud Functions">OpenShift Cloud Functions</a>
        </li>
      </ul>
    </li>
  </ul>
</nav>
      <div class="rhd-footer-sidebar">
        <p class="rhd-footer-sidebar-title">Red Hat Developer</p>
        <p class="rhd-footer-sidebar-subtitle">Build here. Go anywhere.</p>
        <p class="rhd-footer-sidebar-content">
          We serve the builders. The problem solvers who create careers with
          code.<br /><br /><a href="https://developer.redhat.com/register">Join us</a>
          if you’re a developer, software engineer, web designer, front-end
          designer, UX designer, computer scientist, architect, tester,
          product manager, project manager or team lead.
        </p>
        <ul class="rhd-footer-sidebar-social">
          <li>
            <a href="https://www.youtube.com/channel/UC7noUdfWp-ukXUlAsJnSm-Q" target="_blank"
              rel="noopener noreferrer"><svg class="svg-inline--fa fa-youtube fa-w-18" aria-hidden="true"
                data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 576 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z">
                </path>
              </svg><!-- <i class="fab fa-youtube"></i> --></a>
          </li>
          <li>
            <a href="https://www.facebook.com/RedHatDeveloperProgram" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-facebook fa-w-14" aria-hidden="true" data-prefix="fab" data-icon="facebook"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M448 56.7v398.5c0 13.7-11.1 24.7-24.7 24.7H309.1V306.5h58.2l8.7-67.6h-67v-43.2c0-19.6 5.4-32.9 33.5-32.9h35.8v-60.5c-6.2-.8-27.4-2.7-52.2-2.7-51.6 0-87 31.5-87 89.4v49.9h-58.4v67.6h58.4V480H24.7C11.1 480 0 468.9 0 455.3V56.7C0 43.1 11.1 32 24.7 32h398.5c13.7 0 24.8 11.1 24.8 24.7z">
                </path>
              </svg><!-- <i class="fab fa-facebook"> </i> --></a>
          </li>
          <li>
            <a href="https://twitter.com/rhdevelopers" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-twitter fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="twitter"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                </path>
              </svg><!-- <i class="fab fa-twitter"> </i> --></a>
          </li>
          <li>
            <a href="https://github.com/redhat-developer" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="github"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
                </path>
              </svg><!-- <i class="fab fa-github"> </i> --></a>
          </li>
        </ul>
        <a class="rhd-footer-sidebar-signup" href="https://developers.redhat.com/register">Sign me up ▸</a>
      </div>
    </div>
  </div>
</footer>
<script src="../_/js/site.js"></script>
<script src="../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>
